<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IB Psychology 2027 Master Suite</title>
<style>
    :root {
        --nav-width: 270px;
        --dark-bg: #0f172a;
        --ib-blue: #0ea5e9;
        --accent-green: #10b981;
        --border: #e2e8f0;
        --text-main: #1e293b;
        --text-muted: #64748b;
    }

    body { font-family: 'Inter', system-ui, sans-serif; margin: 0; display: flex; background: #f8fafc; color: var(--text-main); }

    /* SIDEBAR */
    #sidebar { width: var(--nav-width); height: 100vh; background: var(--dark-bg); color: white; position: fixed; overflow-y: auto; z-index: 1000; }
    #sidebar header { padding: 20px; border-bottom: 1px solid #1e293b; text-align: center; }
    #sidebar header h2 { font-size: 1rem; margin: 0; color: #38bdf8; letter-spacing: 1px; }
    
    .nav-cat { padding: 15px 20px 5px; font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1.2px; font-weight: 700; }
    #sidebar ul { list-style: none; padding: 0; margin: 0; }
    #sidebar li a { display: block; padding: 10px 20px; color: #cbd5e1; text-decoration: none; font-size: 0.85rem; cursor: pointer; transition: 0.2s; border-left: 3px solid transparent; }
    #sidebar li a:hover { background: #1e293b; color: white; }
    #sidebar li a.active { background: var(--ib-blue); color: white; border-left: 3px solid #fff; }

    /* MAIN CONTAINER */
    .container { margin-left: var(--nav-width); padding: 40px; width: calc(100% - var(--nav-width)); max-width: 950px; padding-bottom: 180px; box-sizing: border-box; }
    .view { display: none; }
    .view.active { display: block; animation: fadeIn 0.2s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .guide-ref { font-size: 0.75rem; color: var(--ib-blue); font-weight: bold; text-transform: uppercase; margin-bottom: 5px; display: block; }
    h1 { font-size: 1.6rem; color: var(--dark-bg); border-bottom: 2px solid var(--ib-blue); padding-bottom: 10px; margin: 0 0 10px; }
    .page-desc { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 20px; }

    /* INPUT FIELDS */
    .context-box { background: #f1f5f9; padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px; }
    .context-box label { display: block; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; }
    .q-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px; font-family: inherit; font-size: 0.9rem; }

    /* RUBRIC CARDS */
    .card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .strand-title { font-weight: 800; color: var(--ib-blue); text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.5px; display: block; margin-bottom: 12px; }
    
    .row-opt { display: flex; align-items: flex-start; padding: 12px; border-radius: 8px; border: 1px solid #f8fafc; cursor: pointer; transition: 0.1s; margin-bottom: 4px; }
    .row-opt:hover { background: #f0f9ff; border-color: #bae6fd; }
    .row-opt input { margin-top: 4px; margin-right: 15px; transform: scale(1.3); }
    
    .mark-tag { font-weight: 700; min-width: 60px; font-size: 0.7rem; padding: 3px 6px; border-radius: 4px; background: #e2e8f0; margin-right: 15px; text-align: center; color: #475569; }
    .txt-body { font-size: 0.95rem; line-height: 1.5; color: #334155; }
    .kw { font-weight: 700; color: #000; background: #fffbeb; padding: 0 2px; }

    /* EXPORT MANAGER */
    .export-row { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid var(--border); }
    .export-row.disabled { opacity: 0.4; pointer-events: none; background: #f1f5f9; }
    .export-row input { margin-right: 15px; width: 18px; height: 18px; }

    /* BOTTOM DOCK */
    .dock-bar { position: fixed; bottom: 0; left: var(--nav-width); right: 0; background: white; border-top: 4px solid var(--ib-blue); padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 -10px 30px rgba(0,0,0,0.1); z-index: 2000; }
    .res-val { font-size: 2.2rem; font-weight: 900; color: var(--ib-blue); line-height: 1; }
    .res-lbl { font-size: 0.65rem; font-weight: 800; color: #64748b; text-transform: uppercase; margin-top: 5px; }

    textarea { width: 100%; height: 100px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-top: 15px; font-family: inherit; font-size: 0.9rem; resize: vertical; box-sizing: border-box; }
    .btn { padding: 10px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; border: none; transition: 0.2s; font-size: 0.8rem; }
    .btn-blue { background: var(--ib-blue); color: white; }
    .btn-green { background: var(--accent-green); color: white; margin-left: 10px; }
    .btn-purple { background: #8b5cf6; color: white; margin-left: 10px; }
    .btn-orange { background: #f97316; color: white; width: 100%; margin-top: 10px; }
    .btn-red { background: #ef4444; color: white; width: 100%; margin-top: 10px; }

    .manual-grade-field { width: 80px; text-align: center; font-weight: 900; color: var(--ib-blue); border: 2px solid var(--ib-blue); padding: 10px; border-radius: 8px; font-size: 1.2rem; }
</style>
</head>
<body>

<nav id="sidebar">
    <header><h2>Psych Marker 2027</h2></header>
    <div class="nav-cat">Paper 1</div>
    <ul>
        <li><a onclick="nav('p1a')" id="btn-p1a" class="active">P1-A: SAQ</a></li>
        <li><a onclick="nav('p1b')" id="btn-p1b">P1-B: Applied SAQ</a></li>
        <li><a onclick="nav('p1c')" id="btn-p1c">P1-C: ERQ (Essay)</a></li>
    </ul>
    <div class="nav-cat">Paper 2</div>
    <ul>
        <li><a onclick="nav('p2aq1')" id="btn-p2aq1">P2-A-Q1: Knowledge</a></li>
        <li><a onclick="nav('p2aq2')" id="btn-p2aq2">P2-A-Q2: Application</a></li>
        <li><a onclick="nav('p2aq3')" id="btn-p2aq3">P2-A-Q3: Compare</a></li>
        <li><a onclick="nav('p2aq4')" id="btn-p2aq4">P2-A-Q4: Design</a></li>
        <li><a onclick="nav('p2b')" id="btn-p2b">P2-B: Unseen Case</a></li>
    </ul>
    <div class="nav-cat">Paper 3</div>
    <ul>
        <li><a onclick="nav('p3q1')" id="btn-p3q1">P3-Q1: Graph Skill</a></li>
        <li><a onclick="nav('p3q2')" id="btn-p3q2">P3-Q2: Conclusion</a></li>
        <li><a onclick="nav('p3q3')" id="btn-p3q3">P3-Q3: Ethics</a></li>
        <li><a onclick="nav('p3q4')" id="btn-p3q4">P3-Q4: Synthesis</a></li>
    </ul>
    <div class="nav-cat">Internal</div>
    <ul>
        <li><a onclick="nav('ia')" id="btn-ia">IA: Research Proposal</a></li>
    </ul>
    <div class="nav-cat">Tools</div>
    <ul>
        <li><a onclick="nav('export')" id="btn-export" style="color: #38bdf8; font-weight: bold;">Export Manager</a></li>
        <li><a onclick="nav('help')" id="btn-help">Help & Pedagogy</a></li>
    </ul>
    <div style="padding: 10px 20px;">
        <button class="btn btn-orange" onclick="resetRubrics()">Reset Student Marking</button>
        <button class="btn btn-red" onclick="resetAll()">Reset All (Full Clear)</button>
    </div>
</nav>

<div class="container">
    
    <template id="section-header">
        <div class="context-box">
            <label>Question / Prompt being assessed</label>
            <input type="text" class="q-input q-field" placeholder="Enter specific question text...">
        </div>
    </template>

    <!-- P1-A SAQ -->
    <div id="p1a" class="view active">
        <span class="guide-ref">Guide Page 51</span>
        <h1>P1-A: Short Answer Question</h1>
        <div class="header-anchor"></div>
        <div class="card">
            <span class="strand-title">Knowledge & Understanding</span>
            <label class="row-opt"><input type="radio" name="p1as1" value="1" onchange="upd()"> <span class="mark-tag">1-2</span> <div class="txt-body">The response demonstrates <span class="kw">limited knowledge</span> relevant to the question.</div></label>
            <label class="row-opt"><input type="radio" name="p1as1" value="2" onchange="upd()"> <span class="mark-tag">3-4</span> <div class="txt-body">The response demonstrates <span class="kw">detailed knowledge</span> relevant to the question.</div></label>
        </div>
        <div class="card">
            <span class="strand-title">Relevance of Example</span>
            <label class="row-opt"><input type="radio" name="p1as2" value="1" onchange="upd()"> <span class="mark-tag">1-2</span> <div class="txt-body">The example is relevant but is <span class="kw">not explained</span>.</div></label>
            <label class="row-opt"><input type="radio" name="p1as2" value="2" onchange="upd()"> <span class="mark-tag">3-4</span> <div class="txt-body">The example is relevant and <span class="kw">explained</span>.</div></label>
        </div>
        <div class="context-box"><label>Manual Mark Entry</label><input type="number" class="manual-grade-field" id="man-p1a" oninput="upd()"></div>
        <textarea id="comm-p1a" placeholder="Comment" oninput="save()"></textarea>
    </div>

    <!-- P1-B APPLIED -->
    <div id="p1b" class="view">
        <span class="guide-ref">Guide Page 51-52</span>
        <h1>P1-B: Applied Short Answer</h1>
        <div class="header-anchor"></div>
        <div class="card">
            <span class="strand-title">Knowledge and understanding</span>
            <label class="row-opt"><input type="radio" name="p1bs1" value="1" onchange="upd()"> <span class="mark-tag">1-2</span> <div class="txt-body">Knowledge and understanding of the question are <span class="kw">limited</span>.</div></label>
            <label class="row-opt"><input type="radio" name="p1bs1" value="2" onchange="upd()"> <span class="mark-tag">3-4</span> <div class="txt-body">Knowledge and understanding have some detail and are <span class="kw">mostly accurate</span>.</div></label>
            <label class="row-opt"><input type="radio" name="p1bs1" value="3" onchange="upd()"> <span class="mark-tag">5-6</span> <div class="txt-body">Knowledge and understanding are <span class="kw">accurate and detailed</span>.</div></label>
        </div>
        <div class="card">
            <span class="strand-title">Application of knowledge</span>
            <label class="row-opt"><input type="radio" name="p1bs2" value="1" onchange="upd()"> <span class="mark-tag">1-2</span> <div class="txt-body">The application of knowledge is relevant but <span class="kw">limited</span>.</div></label>
            <label class="row-opt"><input type="radio" name="p1bs2" value="2" onchange="upd()"> <span class="mark-tag">3-4</span> <div class="txt-body">The application of knowledge is relevant and <span class="kw">partially developed</span>.</div></label>
            <label class="row-opt"><input type="radio" name="p1bs2" value="3" onchange="upd()"> <span class="mark-tag">5-6</span> <div class="txt-body">The application of relevant knowledge is <span class="kw">well developed</span>.</div></label>
        </div>
        <div class="context-box"><label>Manual Mark Entry</label><input type="number" class="manual-grade-field" id="man-p1b" oninput="upd()"></div>
        <textarea id="comm-p1b" placeholder="Comment" oninput="save()"></textarea>
    </div>

    <!-- P1-C ERQ -->
    <div id="p1c" class="view">
        <span class="guide-ref">Guide Page 52-53</span>
        <h1>P1-C: Extended Response (Essay)</h1>
        <div class="header-anchor"></div>
        <div class="card">
            <span class="strand-title">Knowledge & Demands</span>
            <label class="row-opt"><input type="radio" name="p1cs1" value="1" onchange="upd()"> <span class="mark-tag">1-3</span> <div class="txt-body">Response indicates <span class="kw">little understanding</span> of demands; knowledge limited/inaccurate.</div></label>
            <label class="row-opt"><input type="radio" name="p1cs1" value="3" onchange="upd()"> <span class="mark-tag">7-9</span> <div class="txt-body">Understanding of demands are <span class="kw">partially addressed</span>. Knowledge <span class="kw">partly explained</span>.</div></label>
            <label class="row-opt"><input type="radio" name="p1cs1" value="5" onchange="upd()"> <span class="mark-tag">13-15</span> <div class="txt-body">Demands of the question are <span class="kw">fully explained</span>. Knowledge <span class="kw">fully explained</span>.</div></label>
        </div>
        <div class="card">
            <span class="strand-title">Critical Analysis</span>
            <label class="row-opt"><input type="radio" name="p1cs2" value="1" onchange="upd()"> <span class="mark-tag">1-3</span> <div class="txt-body">Analysis <span class="kw">superficial or incoherent</span>. Links not stated.</div></label>
            <label class="row-opt"><input type="radio" name="p1cs2" value="3" onchange="upd()"> <span class="mark-tag">7-9</span> <div class="txt-body">Analysis <span class="kw">lacks development</span>. Links are <span class="kw">partly relevant</span>.</div></label>
            <label class="row-opt"><input type="radio" name="p1cs2" value="5" onchange="upd()"> <span class="mark-tag">13-15</span> <div class="txt-body"><span class="kw">Well-developed critical analysis</span>. Links <span class="kw">fully explained</span>.</div></label>
        </div>
        <div class="card">
            <span class="strand-title">Terminology & Conclusion</span>
            <label class="row-opt"><input type="radio" name="p1cs3" value="1" onchange="upd()"> <span class="mark-tag">1-3</span> <div class="txt-body">Terminology <span class="kw">not used</span>. Conclusion missing or not consistent.</div></label>
            <label class="row-opt"><input type="radio" name="p1cs3" value="3" onchange="upd()"> <span class="mark-tag">7-9</span> <div class="txt-body">Terminology used <span class="kw">sometimes appropriately</span>. Conclusion inconsistent.</div></label>
            <label class="row-opt"><input type="radio" name="p1cs3" value="5" onchange="upd()"> <span class="mark-tag">13-15</span> <div class="txt-body"><span class="kw">Accurate and precise</span> terminology. Reasoned <span class="kw">clearly stated conclusion</span>.</div></label>
        </div>
        <div class="context-box"><label>Manual Mark Entry</label><input type="number" class="manual-grade-field" id="man-p1c" oninput="upd()"></div>
        <textarea id="comm-p1c" placeholder="Comment" oninput="save()"></textarea>
    </div>

    <!-- P2A Q1-4 -->
    <div id="p2aq1" class="view"><h1>P2-A-Q1: Knowledge</h1><div class="header-anchor"></div><div class="card"><label class="row-opt"><input type="radio" name="p2q1r" value="1" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body">Limited knowledge; inaccuracies.</div></label><label class="row-opt"><input type="radio" name="p2q1r" value="2" onchange="upd()"><span class="mark-tag">3-4</span><div class="txt-body">Detailed knowledge; accurate terminology.</div></label></div><input type="number" class="manual-grade-field" id="man-p2aq1" oninput="upd()"><textarea id="comm-p2aq1" placeholder="Comment"></textarea></div>

    <!-- IA (DENSE SUMMATIVE LOGIC) -->
    <div id="ia" class="view">
        <span class="guide-ref">Guide Page 64-65</span>
        <h1>IA: Research Proposal</h1>
        <div class="header-anchor"></div>
        <div class="card">
            <span class="strand-title">Criterion A: Introduction (6m)</span>
            <label class="row-opt"><input type="radio" name="iaar" value="2" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body">Aim <span class="kw">broad</span>. Problem stated. 1-2 studies not relevant.</div></label>
            <label class="row-opt"><input type="radio" name="iaar" value="4" onchange="upd()"><span class="mark-tag">3-4</span><div class="txt-body">Aim stated but <span class="kw">partially focused</span>. 2 studies linked.</div></label>
            <label class="row-opt"><input type="radio" name="iaar" value="6" onchange="upd()"><span class="mark-tag">5-6</span><div class="txt-body">Aim <span class="kw">clearly stated and focused</span>. Impact explained. Studies relevant.</div></label>
        </div>
        <div class="card">
            <span class="strand-title">Criterion B: Methodology (6m)</span>
            <label class="row-opt"><input type="radio" name="iabr" value="2" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body">Method errors. Procedure unclear. Ethics not linked.</div></label>
            <label class="row-opt"><input type="radio" name="iabr" value="4" onchange="upd()"><span class="mark-tag">3-4</span><div class="txt-body">Choice described. Ethical considerations mentioned.</div></label>
            <label class="row-opt"><input type="radio" name="iabr" value="6" onchange="upd()"><span class="mark-tag">5-6</span><div class="txt-body">Choice <span class="kw">explained</span>. Procedure detailed. Ethics linked.</div></label>
        </div>
        <div class="card">
            <span class="strand-title">Criterion C: Data Collection (6m)</span>
            <label class="row-opt"><input type="radio" name="iacr" value="2" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body">Tool errors. Potential challenges generic.</div></label>
            <label class="row-opt"><input type="radio" name="iacr" value="4" onchange="upd()"><span class="mark-tag">3-4</span><div class="txt-body">Tool appropriate. Decisions described.</div></label>
            <label class="row-opt"><input type="radio" name="iacr" value="6" onchange="upd()"><span class="mark-tag">5-6</span><div class="txt-body"><span class="kw">Effective tool</span> created. Decisions explained.</div></label>
        </div>
        <div class="card">
            <span class="strand-title">Criterion D: Discussion (6m)</span>
            <label class="row-opt"><input type="radio" name="iadr" value="2" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body">Implications not addressed. Bias identified.</div></label>
            <label class="row-opt"><input type="radio" name="iadr" value="4" onchange="upd()"><span class="mark-tag">3-4</span><div class="txt-body">Implications partially addressed. Bias described.</div></label>
            <label class="row-opt"><input type="radio" name="iadr" value="6" onchange="upd()"><span class="mark-tag">5-6</span><div class="txt-body"><span class="kw">Implications explained</span>. Additional method discussed.</div></label>
        </div>
        <div class="context-box"><label>Manual Mark Override</label><input type="number" class="manual-grade-field" id="man-ia" oninput="upd()"></div>
        <textarea id="comm-ia" placeholder="Comment" oninput="save()"></textarea>
    </div>

    <!-- REMAINING FULL RUBRICS INCLUDED BELOW (P2B, P3, ETC) -->
    <div id="p2aq2" class="view"><h1>P2-A-Q2</h1><div class="header-anchor"></div><div class="card"><label class="row-opt"><input type="radio" name="p2aq2r" value="1" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body">Limited application.</div></label><label class="row-opt"><input type="radio" name="p2aq2r" value="2" onchange="upd()"><span class="mark-tag">3-4</span><div class="txt-body">Well-developed application.</div></label></div><input type="number" class="manual-grade-field" id="man-p2aq2" oninput="upd()"><textarea id="comm-p2aq2" placeholder="Comment"></textarea></div>
    <div id="p2aq3" class="view"><h1>P2-A-Q3</h1><div class="header-anchor"></div><div class="card"><label class="row-opt"><input type="radio" name="p2aq3r" value="1" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body">Limited detail.</div></label><label class="row-opt"><input type="radio" name="p2aq3r" value="2" onchange="upd()"><span class="mark-tag">3-4</span><div class="txt-body">Lacks clarity.</div></label><label class="row-opt"><input type="radio" name="p2aq3r" value="3" onchange="upd()"><span class="mark-tag">5-6</span><div class="txt-body">Discussed in detail.</div></label></div><input type="number" class="manual-grade-field" id="man-p2aq3" oninput="upd()"><textarea id="comm-p2aq3" placeholder="Comment"></textarea></div>
    <div id="p2aq4" class="view"><h1>P2-A-Q4</h1><div class="header-anchor"></div><div class="card"><label class="row-opt"><input type="radio" name="p2aq4r" value="1" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body">Limited detail.</div></label><label class="row-opt"><input type="radio" name="p2aq4r" value="2" onchange="upd()"><span class="mark-tag">3-4</span><div class="txt-body">Some detail.</div></label><label class="row-opt"><input type="radio" name="p2aq4r" value="3" onchange="upd()"><span class="mark-tag">5-6</span><div class="txt-body">Accuracy and detail.</div></label></div><input type="number" class="manual-grade-field" id="man-p2aq4" oninput="upd()"><textarea id="comm-p2aq4" placeholder="Comment"></textarea></div>
    <div id="p2b" class="view"><h1>P2-B: Unseen</h1><div class="header-anchor"></div><div class="card"><span class="strand-title">Strand 1</span><label class="row-opt"><input type="radio" name="p2bs1" value="1" onchange="upd()"><span class="mark-tag">1-3</span><div class="txt-body">Little understanding.</div></label><label class="row-opt"><input type="radio" name="p2bs1" value="3" onchange="upd()"><span class="mark-tag">7-9</span><div class="txt-body">Some understanding.</div></label><label class="row-opt"><input type="radio" name="p2bs1" value="5" onchange="upd()"><span class="mark-tag">13-15</span><div class="txt-body">Very good understanding.</div></label></div><input type="number" class="manual-grade-field" id="man-p2b" oninput="upd()"><textarea id="comm-p2b" placeholder="Comment"></textarea></div>
    <div id="p3q1" class="view"><h1>P3-Q1</h1><div class="header-anchor"></div><div class="card"><label class="row-opt"><input type="radio" name="p3q1r" value="1" onchange="upd()"><span class="mark-tag">1</span><div class="txt-body">Identified.</div></label><label class="row-opt"><input type="radio" name="p3q1r" value="3" onchange="upd()"><span class="mark-tag">3</span><div class="txt-body">Explained.</div></label></div><input type="number" class="manual-grade-field" id="man-p3q1" oninput="upd()"><textarea id="comm-p3q1" placeholder="Comment"></textarea></div>
    <div id="p3q2" class="view"><h1>P3-Q2</h1><div class="header-anchor"></div><div class="card"><label class="row-opt"><input type="radio" name="p3q2r" value="1" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body">Limited.</div></label><label class="row-opt"><input type="radio" name="p3q2r" value="3" onchange="upd()"><span class="mark-tag">5-6</span><div class="txt-body">Detailed.</div></label></div><input type="number" class="manual-grade-field" id="man-p3q2" oninput="upd()"><textarea id="comm-p3q2" placeholder="Comment"></textarea></div>
    <div id="p3q3" class="view"><h1>P3-Q3</h1><div class="header-anchor"></div><div class="card"><label class="row-opt"><input type="radio" name="p3q3r" value="1" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body">Limited.</div></label><label class="row-opt"><input type="radio" name="p3q3r" value="3" onchange="upd()"><span class="mark-tag">5-6</span><div class="txt-body">Detailed.</div></label></div><input type="number" class="manual-grade-field" id="man-p3q3" oninput="upd()"><textarea id="comm-p3q3" placeholder="Comment"></textarea></div>
    <div id="p3q4" class="view"><h1>P3-Q4</h1><div class="header-anchor"></div><div class="card"><span class="strand-title">Strand 1</span><label class="row-opt"><input type="radio" name="p3q4s1" value="1" onchange="upd()"><span class="mark-tag">1-3</span><div class="txt-body">Anecdotal.</div></label><label class="row-opt"><input type="radio" name="p3q4s1" value="3" onchange="upd()"><span class="mark-tag">7-9</span><div class="txt-body">Satisfactory.</div></label><label class="row-opt"><input type="radio" name="p3q4s1" value="5" onchange="upd()"><span class="mark-tag">13-15</span><div class="txt-body">Effective.</div></label></div><input type="number" class="manual-grade-field" id="man-p3q4" oninput="upd()"><textarea id="comm-p3q4" placeholder="Comment"></textarea></div>

    <!-- EXPORT MANAGER -->
    <div id="export" class="view">
        <h1>Export Manager</h1>
        <p class="desc">Only sections with marking data or comments are active. Questions do not trigger inclusion.</p>
        <div class="card" id="export-list"></div>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button class="btn btn-blue" onclick="doExport('simple')">Download Simple Feedback (.txt)</button>
            <button class="btn btn-green" onclick="doExport('student')">Generate AI Drafting Prompt (Student AI)</button>
            <button class="btn btn-purple" onclick="doExport('teacher')">Generate AI Formatted Report (Teacher AI)</button>
        </div>
    </div>

    <!-- HELP VIEW -->
    <div id="help" class="view">
        <h1>Help & Pedagogy</h1>
        <div class="card">
            <h3>Assessment Logic</h3>
            <p><strong>Exam Papers (Best-Fit):</strong> Calculates achievement across strands to identify the most appropriate mark range.</p>
            <p><strong>Internal Assessment (Summative):</strong> Sums marks across the 4 criteria for a total out of 24.</p>
            <h3>Export Utility</h3>
            <p><strong>AI Reporting:</strong> Fixes typos and clarifies shorthand without altering teacher judgment. Focuses on the "Top 3" improvements needed based on the lowest scoring areas.</p>
        </div>
    </div>

    <!-- BOTTOM DOCK -->
    <div class="dock-bar">
        <div class="fit-info">
            <h3 id="fit-title">Select descriptors...</h3>
            <p id="fit-logic">Sums achievement for IA; averages for exam papers.</p>
        </div>
        <div class="res-box">
            <span class="res-val" id="score-out">0</span>
            <span class="res-lbl">Total Mark / Best Fit</span>
        </div>
    </div>

</div>

<script>
    const KEY = 'psych2027_summative_v1';

    // Inject headers
    document.querySelectorAll('.view:not(#export):not(#help)').forEach(v => {
        const anchor = v.querySelector('.header-anchor');
        const clone = document.getElementById('section-header').content.cloneNode(true);
        v.insertBefore(clone, anchor);
    });

    function nav(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('#sidebar a').forEach(a => a.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        const btn = document.getElementById('btn-' + id);
        if(btn) btn.classList.add('active');
        window.scrollTo(0,0);
        if(id === 'export') renderExport();
        upd();
    }

    function upd() {
        const active = document.querySelector('.view.active');
        if(!active || ['export','help'].includes(active.id)) return;
        const manField = active.querySelector('.manual-grade-field');
        const checked = active.querySelectorAll('input[type="radio"]:checked');
        const display = document.getElementById('score-out');
        const title = document.getElementById('fit-title');

        if(manField && manField.value !== "") {
            display.innerText = manField.value;
            title.innerText = "Manual Assignment";
            save(); return;
        }

        if (checked.length === 0) { display.innerText = "0"; title.innerText = "Select descriptors..."; return; }

        let pts = 0; checked.forEach(r => pts += parseFloat(r.value));
        let vid = active.id;

        if (vid === 'ia') {
            display.innerText = pts;
            title.innerText = `IA Total: ${pts} / 24`;
        } else if (['p1c', 'p2b', 'p3q4'].includes(vid)) {
            let avg = pts / checked.length;
            const ranges = ["0", "1-3", "4-6", "7-9", "10-12", "13-15"];
            display.innerText = ranges[Math.round(avg)];
            title.innerText = ["N/A", "Rudimentary", "Basic", "Satisfactory", "Good", "Excellent"][Math.round(avg)];
        } else {
            let avg = pts / checked.length;
            display.innerText = Math.round(avg * 2);
            title.innerText = avg > 1.5 ? "Detailed" : "Developing";
        }
        save();
    }

    function save() {
        const data = {};
        document.querySelectorAll('input[type="radio"]:checked').forEach(r => data[r.name] = r.value);
        document.querySelectorAll('textarea, .q-field, .manual-grade-field').forEach(t => {
            const id = t.id || t.className+t.closest('.view').id;
            data[id] = t.value;
        });
        localStorage.setItem(KEY, JSON.stringify(data));
    }

    function load() {
        const raw = localStorage.getItem(KEY); if(!raw) return;
        const data = JSON.parse(raw);
        for(let k in data) {
            const rad = document.querySelector(`input[name="${k}"][value="${data[k]}"]`);
            if(rad) rad.checked = true;
            const fields = document.querySelectorAll('textarea, .q-field, .manual-grade-field');
            fields.forEach(f => {
                if((f.id === k) || (f.className+f.closest('.view').id === k)) f.value = data[k];
            });
        }
        upd();
    }

    function resetRubrics() {
        if(confirm("Wipe student markings/comments? (Questions stay)")) {
            document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
            document.querySelectorAll('textarea, .manual-grade-field').forEach(t => t.value = "");
            save(); upd();
        }
    }

    function resetAll() {
        if(confirm("Full Reset?")) { localStorage.removeItem(KEY); location.reload(); }
    }

    function renderExport() {
        const list = document.getElementById('export-list');
        list.innerHTML = "";
        document.querySelectorAll('.view').forEach(v => {
            if(['export','help'].includes(v.id)) return;
            const hasData = v.querySelectorAll('input[type="radio"]:checked').length > 0 || v.querySelector('textarea').value.trim() !== "";
            const row = document.createElement('div');
            row.className = `export-row ${!hasData ? 'disabled' : ''}`;
            row.innerHTML = `<input type="checkbox" id="chk-${v.id}" ${hasData ? 'checked' : ''}> <label>${v.querySelector('h1').innerText}</label>`;
            list.appendChild(row);
        });
    }

    function doExport(type) {
        let text = "IB PSYCHOLOGY FEEDBACK DATA\n=========================\n\n";
        document.querySelectorAll('.view').forEach(v => {
            const chk = document.getElementById('chk-'+v.id);
            if(chk && chk.checked) {
                const q = v.querySelector('.q-field').value;
                const man = v.querySelector('.manual-grade-field').value;
                text += `SECTION: ${v.querySelector('h1').innerText}\n`;
                if(q) text += `QUESTION: ${q}\n`;
                v.querySelectorAll('input[type="radio"]:checked').forEach(r => {
                    text += `- ${r.closest('.card').querySelector('.strand-title').innerText}: [LEVEL_VAL:${r.value}] ${r.parentElement.innerText.trim()}\n`;
                });
                if(man) text += `FINAL ASSIGNED MARK: ${man}\n`;
                if(v.querySelector('textarea').value) text += `TEACHER COMMENT: ${v.querySelector('textarea').value}\n`;
                text += "\n---\n";
            }
        });

        if(type === 'student') {
            text = `ACT AS AN IB PSYCHOLOGY TUTOR (2027 GUIDE). Identify "Keyword Shifts" required based on data provided.\n\n${text}`;
        } else if(type === 'teacher') {
            text = `ACT AS A FORMAL PEDAGOGICAL FEEDBACK PROCESSOR (IB PSYCHOLOGY 2027 GUIDE). 
INSTRUCTIONS:
1. Fix typos/grammar in teacher comments without changing meaning or tone.
2. Group feedback professionally.
3. Identify TOP 3 priority improvements based on lowest [LEVEL_VAL] scores.
DATA:\n${text}`;
        }

        const blob = new Blob([text], {type: "text/plain"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Psych_2027_${type}.txt`;
        a.click();
    }

    window.onload = load;
</script>
</body>
</html>
