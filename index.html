<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IB Psychology 2027 Master Suite</title>
<style>
    :root {
        --nav-width: 270px;
        --dark-bg: #0f172a;
        --ib-blue: #0ea5e9;
        --accent-green: #10b981;
        --border: #e2e8f0;
        --text-main: #1e293b;
        --text-muted: #64748b;
    }

    body { font-family: 'Inter', -apple-system, sans-serif; margin: 0; display: flex; background: #f8fafc; color: var(--text-main); }

    /* SIDEBAR DOCK */
    #sidebar { width: var(--nav-width); height: 100vh; background: var(--dark-bg); color: white; position: fixed; overflow-y: auto; z-index: 1000; }
    #sidebar header { padding: 20px; border-bottom: 1px solid #1e293b; text-align: center; }
    #sidebar header h2 { font-size: 1rem; margin: 0; color: #38bdf8; letter-spacing: 1px; }
    
    .nav-cat { padding: 15px 20px 5px; font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1.2px; font-weight: 700; }
    #sidebar ul { list-style: none; padding: 0; margin: 0; }
    #sidebar li a { display: block; padding: 10px 25px; color: #cbd5e1; text-decoration: none; font-size: 0.85rem; cursor: pointer; transition: 0.2s; border-left: 3px solid transparent; }
    #sidebar li a:hover { background: #1e293b; color: white; }
    #sidebar li a.active { background: var(--ib-blue); color: white; border-left: 3px solid #fff; }

    /* MAIN CONTAINER */
    .container { margin-left: var(--nav-width); padding: 40px; width: calc(100% - var(--nav-width)); max-width: 950px; padding-bottom: 180px; box-sizing: border-box; }
    .view { display: none; }
    .view.active { display: block; animation: fadeIn 0.2s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .guide-ref { font-size: 0.75rem; color: var(--ib-blue); font-weight: bold; text-transform: uppercase; margin-bottom: 5px; display: block; }
    h1 { font-size: 1.6rem; color: var(--dark-bg); border-bottom: 2px solid var(--ib-blue); padding-bottom: 10px; margin: 0 0 10px; }
    
    /* INPUT FIELDS */
    .context-box { background: #f1f5f9; padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px; }
    .context-box label { display: block; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; }
    .q-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px; font-family: inherit; font-size: 0.9rem; }

    /* RUBRIC CARDS */
    .card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .strand-title { font-weight: 800; color: var(--ib-blue); text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.5px; display: block; margin-bottom: 12px; }
    
    .row-opt { display: flex; align-items: flex-start; padding: 12px; border-radius: 8px; border: 1px solid #f8fafc; cursor: pointer; transition: 0.1s; margin-bottom: 4px; }
    .row-opt:hover { background: #f0f9ff; border-color: #bae6fd; }
    .row-opt input { margin-top: 4px; margin-right: 15px; transform: scale(1.3); }
    
    .mark-tag { font-weight: 700; min-width: 60px; font-size: 0.7rem; padding: 3px 6px; border-radius: 4px; background: #e2e8f0; margin-right: 15px; text-align: center; color: #475569; }
    .txt-body { font-size: 0.95rem; line-height: 1.5; color: #334155; }
    .kw { font-weight: 700; color: #000; background: #fffbeb; padding: 0 2px; }

    /* EXPORT MANAGER */
    .export-row { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid var(--border); }
    .export-row.disabled { opacity: 0.4; pointer-events: none; background: #f1f5f9; }
    .export-row input { margin-right: 15px; width: 18px; height: 18px; }

    /* BOTTOM DOCK */
    .dock-bar { position: fixed; bottom: 0; left: var(--nav-width); right: 0; background: white; border-top: 4px solid var(--ib-blue); padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 -10px 30px rgba(0,0,0,0.1); z-index: 2000; }
    .res-val { font-size: 2.2rem; font-weight: 900; color: var(--ib-blue); line-height: 1; }
    .res-lbl { font-size: 0.65rem; font-weight: 800; color: #64748b; text-transform: uppercase; margin-top: 5px; }

    textarea { width: 100%; height: 100px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-top: 15px; font-family: inherit; font-size: 0.9rem; resize: vertical; box-sizing: border-box; }
    .btn { padding: 10px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; border: none; transition: 0.2s; font-size: 0.8rem; }
    .btn-blue { background: var(--ib-blue); color: white; }
    .btn-green { background: var(--accent-green); color: white; margin-left: 10px; }
    .btn-purple { background: #8b5cf6; color: white; margin-left: 10px; }
    .btn-orange { background: #f97316; color: white; width: 100%; margin-top: 10px; }
    .btn-red { background: #ef4444; color: white; width: 100%; margin-top: 10px; }

    .manual-grade-field { width: 80px; text-align: center; font-weight: 900; color: var(--ib-blue); border: 2px solid var(--ib-blue); padding: 10px; border-radius: 8px; font-size: 1.2rem; }
</style>
</head>
<body>

<nav id="sidebar">
    <header><h2>Psych Marker 2027</h2></header>
    <div class="nav-cat">Paper 1</div>
    <ul>
        <li><a onclick="nav('p1a')" id="btn-p1a" class="active">P1-A: SAQ</a></li>
        <li><a onclick="nav('p1b')" id="btn-p1b">P1-B: Applied SAQ</a></li>
        <li><a onclick="nav('p1c')" id="btn-p1c">P1-C: ERQ (Essay)</a></li>
    </ul>
    <div class="nav-cat">Paper 2</div>
    <ul>
        <li><a onclick="nav('p2aq1')" id="btn-p2aq1">P2-A-Q1: Knowledge</a></li>
        <li><a onclick="nav('p2aq2')" id="btn-p2aq2">P2-A-Q2: Application</a></li>
        <li><a onclick="nav('p2aq3')" id="btn-p2aq3">P2-A-Q3: Compare</a></li>
        <li><a onclick="nav('p2aq4')" id="btn-p2aq4">P2-A-Q4: Design</a></li>
        <li><a onclick="nav('p2b')" id="btn-p2b">P2-B: Unseen Case</a></li>
    </ul>
    <div class="nav-cat">Paper 3</div>
    <ul>
        <li><a onclick="nav('p3q1')" id="btn-p3q1">P3-Q1: Graph Skill</a></li>
        <li><a onclick="nav('p3q2')" id="btn-p3q2">P3-Q2: Conclusion</a></li>
        <li><a onclick="nav('p3q3')" id="btn-p3q3">P3-Q3: Ethics</a></li>
        <li><a onclick="nav('p3q4')" id="btn-p3q4">P3-Q4: Synthesis</a></li>
    </ul>
    <div class="nav-cat">Internal</div>
    <ul>
        <li><a onclick="nav('ia')" id="btn-ia">IA: Research Proposal</a></li>
    </ul>
    <div class="nav-cat">Tools</div>
    <ul>
        <li><a onclick="nav('export')" id="btn-export" style="color: #38bdf8; font-weight: bold;">Export Manager</a></li>
        <li><a onclick="nav('help')" id="btn-help">Help & Pedagogy</a></li>
    </ul>
    <div style="padding: 10px 20px;">
        <button class="btn btn-orange" onclick="resetRubrics()">Reset Student Marking</button>
        <button class="btn btn-red" onclick="resetAll()">Reset All (Full Clear)</button>
    </div>
</nav>

<div class="container">
    
    <template id="section-header">
        <div class="context-box">
            <label>Question / Prompt Text</label>
            <input type="text" class="q-input q-field" placeholder="Enter specific question text to anchor feedback...">
        </div>
    </template>

    <!-- PAPER 1 SECTION A -->
    <div id="p1a" class="view active">
        <span class="guide-ref">Guide Page 51</span>
        <h1>P1-A: Short Answer Question</h1>
        <div class="header-anchor"></div>
        <div class="card">
            <span class="strand-title">Knowledge & Understanding</span>
            <label class="row-opt"><input type="radio" name="p1as1" value="1" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body">Response demonstrates <span class="kw">limited knowledge</span> relevant to the question.</div></label>
            <label class="row-opt"><input type="radio" name="p1as1" value="2" onchange="upd()"><span class="mark-tag">3-4</span><div class="txt-body">Response demonstrates <span class="kw">detailed knowledge</span> relevant to the question.</div></label>
        </div>
        <div class="card">
            <span class="strand-title">Application of Example</span>
            <label class="row-opt"><input type="radio" name="p1as2" value="1" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body">Example is relevant but is <span class="kw">not explained</span>.</div></label>
            <label class="row-opt"><input type="radio" name="p1as2" value="2" onchange="upd()"><span class="mark-tag">3-4</span><div class="txt-body">Example is relevant and <span class="kw">explained</span>.</div></label>
        </div>
        <div class="context-box"><label>Manual Override</label><input type="number" class="manual-grade-field" id="man-p1a" oninput="upd()"></div>
        <textarea id="comm-p1a" placeholder="Comment" oninput="save()"></textarea>
    </div>

    <!-- PAPER 1 SECTION B -->
    <div id="p1b" class="view">
        <span class="guide-ref">Guide Page 51-52</span>
        <h1>P1-B: Applied Short Answer</h1>
        <div class="header-anchor"></div>
        <div class="card">
            <span class="strand-title">Accuracy and detail</span>
            <label class="row-opt"><input type="radio" name="p1bs1" value="1" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body">Knowledge and understanding are <span class="kw">limited</span>.</div></label>
            <label class="row-opt"><input type="radio" name="p1bs1" value="2" onchange="upd()"><span class="mark-tag">3-4</span><div class="txt-body">Knowledge has <span class="kw">some detail</span> and is <span class="kw">mostly accurate</span>.</div></label>
            <label class="row-opt"><input type="radio" name="p1bs1" value="3" onchange="upd()"><span class="mark-tag">5-6</span><div class="txt-body">Knowledge and understanding are <span class="kw">accurate and detailed</span>.</div></label>
        </div>
        <div class="card">
            <span class="strand-title">Application of relevant knowledge</span>
            <label class="row-opt"><input type="radio" name="p1bs2" value="1" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body">The application is relevant but <span class="kw">limited</span>.</div></label>
            <label class="row-opt"><input type="radio" name="p1bs2" value="2" onchange="upd()"><span class="mark-tag">3-4</span><div class="txt-body">The application is relevant and <span class="kw">partially developed</span>.</div></label>
            <label class="row-opt"><input type="radio" name="p1bs2" value="3" onchange="upd()"><span class="mark-tag">5-6</span><div class="txt-body">The application is <span class="kw">well developed</span>.</div></label>
        </div>
        <div class="context-box"><label>Manual Override</label><input type="number" class="manual-grade-field" id="man-p1b" oninput="upd()"></div>
        <textarea id="comm-p1b" placeholder="Comment" oninput="save()"></textarea>
    </div>

    <!-- PAPER 1 SECTION C -->
    <div id="p1c" class="view">
        <span class="guide-ref">Guide Page 52-53</span>
        <h1>P1-C: Extended Response (Essay)</h1>
        <div class="header-anchor"></div>
        <div class="card">
            <span class="strand-title">Strand 1: Understanding Demands & Knowledge</span>
            <label class="row-opt"><input type="radio" name="p1cs1" value="1" onchange="upd()"><span class="mark-tag">1-3</span><div class="txt-body"><span class="kw">Little understanding</span> of demands; knowledge very limited.</div></label>
            <label class="row-opt"><input type="radio" name="p1cs1" value="2" onchange="upd()"><span class="mark-tag">4-6</span><div class="txt-body"><span class="kw">Some understanding</span> of demands; knowledge <span class="kw">described</span>.</div></label>
            <label class="row-opt"><input type="radio" name="p1cs1" value="3" onchange="upd()"><span class="mark-tag">7-9</span><div class="txt-body">Demands <span class="kw">partially addressed</span>; knowledge <span class="kw">partly explained</span>.</div></label>
            <label class="row-opt"><input type="radio" name="p1cs1" value="4" onchange="upd()"><span class="mark-tag">10-12</span><div class="txt-body">Demands <span class="kw">addressed</span>; knowledge <span class="kw">mostly explained</span>.</div></label>
            <label class="row-opt"><input type="radio" name="p1cs1" value="5" onchange="upd()"><span class="mark-tag">13-15</span><div class="txt-body">Demands <span class="kw">fully explained</span>; knowledge <span class="kw">fully explained</span>.</div></label>
        </div>
        <div class="card">
            <span class="strand-title">Strand 2: Critical Analysis & Synthesis</span>
            <label class="row-opt"><input type="radio" name="p1cs2" value="1" onchange="upd()"><span class="mark-tag">1-3</span><div class="txt-body">Analysis <span class="kw">superficial or incoherent</span>.</div></label>
            <label class="row-opt"><input type="radio" name="p1cs2" value="2" onchange="upd()"><span class="mark-tag">4-6</span><div class="txt-body">Limited analysis; overall <span class="kw">more descriptive</span>.</div></label>
            <label class="row-opt"><input type="radio" name="p1cs2" value="3" onchange="upd()"><span class="mark-tag">7-9</span><div class="txt-body">Analysis <span class="kw">lacks development</span>; links partly relevant.</div></label>
            <label class="row-opt"><input type="radio" name="p1cs2" value="4" onchange="upd()"><span class="mark-tag">10-12</span><div class="txt-body">Contains <span class="kw">critical analysis</span>; reasoning presented.</div></label>
            <label class="row-opt"><input type="radio" name="p1cs2" value="5" onchange="upd()"><span class="mark-tag">13-15</span><div class="txt-body"><span class="kw">Well-developed critical analysis</span>; reasoned conclusion.</div></label>
        </div>
        <div class="card">
            <span class="strand-title">Strand 3: Terminology & Conclusion</span>
            <label class="row-opt"><input type="radio" name="p1cs3" value="1" onchange="upd()"><span class="mark-tag">1-3</span><div class="txt-body">Terminology <span class="kw">not used</span>; conclusion missing.</div></label>
            <label class="row-opt"><input type="radio" name="p1cs3" value="2" onchange="upd()"><span class="mark-tag">4-6</span><div class="txt-body">Terminology <span class="kw">inappropriate</span>; <span class="kw">simplistic</span> conclusion.</div></label>
            <label class="row-opt"><input type="radio" name="p1cs3" value="3" onchange="upd()"><span class="mark-tag">7-9</span><div class="txt-body">Terminology <span class="kw">sometimes appropriate</span>; inconsistent conclusion.</div></label>
            <label class="row-opt"><input type="radio" name="p1cs3" value="4" onchange="upd()"><span class="mark-tag">10-12</span><div class="txt-body">Terminology <span class="kw">mostly appropriate</span>; consistent conclusion.</div></label>
            <label class="row-opt"><input type="radio" name="p1cs3" value="5" onchange="upd()"><span class="mark-tag">13-15</span><div class="txt-body"><span class="kw">Accurate and precise</span> terminology; reasoned conclusion.</div></label>
        </div>
        <div class="context-box"><label>Manual Override</label><input type="number" class="manual-grade-field" id="man-p1c" oninput="upd()"></div>
        <textarea id="comm-p1c" placeholder="Comment" oninput="save()"></textarea>
    </div>

    <!-- PAPER 2 SECTION A -->
    <div id="p2aq1" class="view"><span class="guide-ref">Guide Page 53</span><h1>P2-A-Q1: Knowledge</h1><div class="header-anchor"></div><div class="card"><label class="row-opt"><input type="radio" name="p2q1r" value="1" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body"><span class="kw">Limited knowledge</span>; terminology inaccuracies.</div></label><label class="row-opt"><input type="radio" name="p2q1r" value="2" onchange="upd()"><span class="mark-tag">3-4</span><div class="txt-body"><span class="kw">Detailed knowledge</span>; terminology used accurately.</div></label></div><input type="number" class="manual-grade-field" id="man-p2aq1" oninput="upd()"><textarea id="comm-p2aq1" placeholder="Comment"></textarea></div>
    <div id="p2aq2" class="view"><span class="guide-ref">Guide Page 53</span><h1>P2-A-Q2: Application</h1><div class="header-anchor"></div><div class="card"><label class="row-opt"><input type="radio" name="p2q2r" value="1" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body"><span class="kw">Some links</span> between concept and practical.</div></label><label class="row-opt"><input type="radio" name="p2q2r" value="2" onchange="upd()"><span class="mark-tag">3-4</span><div class="txt-body"><span class="kw">Clear and detailed</span> links back to practical.</div></label></div><input type="number" class="manual-grade-field" id="man-p2aq2" oninput="upd()"><textarea id="comm-p2aq2" placeholder="Comment"></textarea></div>
    <div id="p2aq3" class="view"><span class="guide-ref">Guide Page 53-54</span><h1>P2-A-Q3: Comparison</h1><div class="header-anchor"></div><div class="card"><label class="row-opt"><input type="radio" name="p2q3r" value="1" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body"><span class="kw">Limited detail</span>; errors in understanding.</div></label><label class="row-opt"><input type="radio" name="p2q3r" value="2" onchange="upd()"><span class="mark-tag">3-4</span><div class="txt-body">Explained in <span class="kw">limited detail</span>; lacks clarity.</div></label><label class="row-opt"><input type="radio" name="p2q3r" value="3" onchange="upd()"><span class="mark-tag">5-6</span><div class="txt-body">Similarities/differences <span class="kw">discussed in detail</span>.</div></label></div><input type="number" class="manual-grade-field" id="man-p2aq3" oninput="upd()"><textarea id="comm-p2aq3" placeholder="Comment"></textarea></div>
    <div id="p2aq4" class="view"><span class="guide-ref">Guide Page 54</span><h1>P2-A-Q4: Design</h1><div class="header-anchor"></div><div class="card"><label class="row-opt"><input type="radio" name="p2q4r" value="1" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body">Procedure described in <span class="kw">limited detail</span>.</div></label><label class="row-opt"><input type="radio" name="p2q4r" value="2" onchange="upd()"><span class="mark-tag">3-4</span><div class="txt-body">Procedure explained in some detail; inaccuracies.</div></label><label class="row-opt"><input type="radio" name="p2q4r" value="3" onchange="upd()"><span class="mark-tag">5-6</span><div class="txt-body">Procedure explained with <span class="kw">accuracy and detail</span>.</div></label></div><input type="number" class="manual-grade-field" id="man-p2aq4" oninput="upd()"><textarea id="comm-p2aq4" placeholder="Comment"></textarea></div>

    <!-- P2-B (VERBATIM 5 ROWS x 3 STRANDS) -->
    <div id="p2b" class="view">
        <span class="guide-ref">Guide Page 54-55</span>
        <h1>P2-B: Unseen Case Study</h1>
        <div class="header-anchor"></div>
        <div class="card">
            <span class="strand-title">Strand 1: Concept Understanding</span>
            <label class="row-opt"><input type="radio" name="p2bs1" value="1" onchange="upd()"><span class="mark-tag">1-3</span><div class="txt-body"><span class="kw">Little understanding</span> of specified concepts. Knowledge limited.</div></label>
            <label class="row-opt"><input type="radio" name="p2bs1" value="2" onchange="upd()"><span class="mark-tag">4-6</span><div class="txt-body"><span class="kw">Basic understanding</span> of at least one specified concept.</div></label>
            <label class="row-opt"><input type="radio" name="p2bs1" value="3" onchange="upd()"><span class="mark-tag">7-9</span><div class="txt-body"><span class="kw">Some understanding</span> of specified concepts; link partially addressed.</div></label>
            <label class="row-opt"><input type="radio" name="p2bs1" value="4" onchange="upd()"><span class="mark-tag">10-12</span><div class="txt-body"><span class="kw">Good understanding</span> of at least two concepts.</div></label>
            <label class="row-opt"><input type="radio" name="p2bs1" value="5" onchange="upd()"><span class="mark-tag">13-15</span><div class="txt-body"><span class="kw">Very good understanding</span> of two or more concepts.</div></label>
        </div>
        <div class="card">
            <span class="strand-title">Strand 2: Critical Analysis</span>
            <label class="row-opt"><input type="radio" name="p2bs2" value="1" onchange="upd()"><span class="mark-tag">1-3</span><div class="txt-body">Response is <span class="kw">descriptive</span>. Analysis superficial. Links irrelevant.</div></label>
            <label class="row-opt"><input type="radio" name="p2bs2" value="2" onchange="upd()"><span class="mark-tag">4-6</span><div class="txt-body">Limited analysis present. Links of <span class="kw">limited relevance</span>.</div></label>
            <label class="row-opt"><input type="radio" name="p2bs2" value="3" onchange="upd()"><span class="mark-tag">7-9</span><div class="txt-body">Analysis <span class="kw">lacks development</span>. Conclusion inconsistent.</div></label>
            <label class="row-opt"><input type="radio" name="p2bs2" value="4" onchange="upd()"><span class="mark-tag">10-12</span><div class="txt-body">Contains critical analysis, although <span class="kw">lacks development</span>.</div></label>
            <label class="row-opt"><input type="radio" name="p2bs2" value="5" onchange="upd()"><span class="mark-tag">13-15</span><div class="txt-body"><span class="kw">Well-developed critical analysis</span>. Effective specific references.</div></label>
        </div>
        <div class="card">
            <span class="strand-title">Strand 3: Terminology & Synthesis</span>
            <label class="row-opt"><input type="radio" name="p2bs3" value="1" onchange="upd()"><span class="mark-tag">1-3</span><div class="txt-body">Terminology <span class="kw">not used</span>. Conclusion missing.</div></label>
            <label class="row-opt"><input type="radio" name="p2bs3" value="2" onchange="upd()"><span class="mark-tag">4-6</span><div class="txt-body">Terminology with <span class="kw">inaccuracies</span>. Simplistic conclusion.</div></label>
            <label class="row-opt"><input type="radio" name="p2bs3" value="3" onchange="upd()"><span class="mark-tag">7-9</span><div class="txt-body">Terminology <span class="kw">sometimes appropriate</span>. Points lack accuracy.</div></label>
            <label class="row-opt"><input type="radio" name="p2bs3" value="4" onchange="upd()"><span class="mark-tag">10-12</span><div class="txt-body">Terminology <span class="kw">mostly appropriately</span> used. Relevant points.</div></label>
            <label class="row-opt"><input type="radio" name="p2bs3" value="5" onchange="upd()"><span class="mark-tag">13-15</span><div class="txt-body"><span class="kw">Accurate and precise</span> terminology. Reasoned conclusion.</div></label>
        </div>
        <div class="context-box"><label>Manual Override</label><input type="number" class="manual-grade-field" id="man-p2b" oninput="upd()"></div>
        <textarea id="comm-p2b" placeholder="Comment" oninput="save()"></textarea>
    </div>

    <!-- PAPER 3 -->
    <div id="p3q1" class="view"><span class="guide-ref">Guide Page 56</span><h1>P3-Q1: Graph Interpretation</h1><div class="header-anchor"></div><div class="card"><span class="strand-title">Identification Skill (3m)</span>
        <label class="row-opt"><input type="radio" name="p3q1r" value="1" onchange="upd()"><span class="mark-tag">1</span><div class="txt-body">Relevant issue <span class="kw">identified</span>.</div></label>
        <label class="row-opt"><input type="radio" name="p3q1r" value="2" onchange="upd()"><span class="mark-tag">2</span><div class="txt-body">Relevant issue <span class="kw">clearly described</span>.</div></label>
        <label class="row-opt"><input type="radio" name="p3q1r" value="3" onchange="upd()"><span class="mark-tag">3</span><div class="txt-body">Relevant issue <span class="kw">explained</span>.</div></label>
    </div><input type="number" class="manual-grade-field" id="man-p3q1" oninput="upd()"><textarea id="comm-p3q1" placeholder="Comment"></textarea></div>

    <div id="p3q2" class="view"><span class="guide-ref">Guide Page 56</span><h1>P3-Q2: Conclusion</h1><div class="header-anchor"></div><div class="card"><span class="strand-title">Analyse findings (6m)</span>
        <label class="row-opt"><input type="radio" name="p3q2r" value="1" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body">Conclusion attempted but <span class="kw">not relevant</span>.</div></label>
        <label class="row-opt"><input type="radio" name="p3q2r" value="2" onchange="upd()"><span class="mark-tag">3-4</span><div class="txt-body">Analysis <span class="kw">lacks detail</span>; link lacks clarity.</div></label>
        <label class="row-opt"><input type="radio" name="p3q2r" value="3" onchange="upd()"><span class="mark-tag">5-6</span><div class="txt-body">The data is <span class="kw">analysed in detail</span>; explicitly linked.</div></label>
    </div><input type="number" class="manual-grade-field" id="man-p3q2" oninput="upd()"><textarea id="comm-p3q2" placeholder="Comment"></textarea></div>

    <div id="p3q3" class="view"><span class="guide-ref">Guide Page 56-57</span><h1>P3-Q3: Ethics</h1><div class="header-anchor"></div><div class="card"><span class="strand-title">Methodology (6m)</span>
        <label class="row-opt"><input type="radio" name="p3q3r" value="1" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body"><span class="kw">Limited understanding</span>; supporting evidence missing.</div></label>
        <label class="row-opt"><input type="radio" name="p3q3r" value="2" onchange="upd()"><span class="mark-tag">3-4</span><div class="txt-body">Shows <span class="kw">some understanding</span>; implicit source links.</div></label>
        <label class="row-opt"><input type="radio" name="p3q3r" value="3" onchange="upd()"><span class="mark-tag">5-6</span><div class="txt-body">Shows <span class="kw">detailed understanding</span>; explicit link.</div></label>
    </div><input type="number" class="manual-grade-field" id="man-p3q3" oninput="upd()"><textarea id="comm-p3q3" placeholder="Comment"></textarea></div>

    <div id="p3q4" class="view">
        <span class="guide-ref">Guide Page 57-58</span>
        <h1>P3-Q4: HL Synthesis</h1>
        <div class="header-anchor"></div>
        <div class="card">
            <span class="strand-title">Strand 1: Integration of Sources</span>
            <label class="row-opt"><input type="radio" name="p3ss1" value="1" onchange="upd()"><span class="mark-tag">1-3</span><div class="txt-body">Knowledge is <span class="kw">anecdotal</span> or of very marginal relevance. Link missing.</div></label>
            <label class="row-opt"><input type="radio" name="p3ss1" value="2" onchange="upd()"><span class="mark-tag">4-6</span><div class="txt-body">Interprets <span class="kw">one source</span>; limited discussion of validity.</div></label>
            <label class="row-opt"><input type="radio" name="p3ss1" value="3" onchange="upd()"><span class="mark-tag">7-9</span><div class="txt-body">Interprets at least <span class="kw">two sources</span>; discussion lacks depth.</div></label>
            <label class="row-opt"><input type="radio" name="p3ss1" value="4" onchange="upd()"><span class="mark-tag">10-12</span><div class="txt-body">Interprets two or more sources to <span class="kw">support the discussion</span>.</div></label>
            <label class="row-opt"><input type="radio" name="p3ss1" value="5" onchange="upd()"><span class="mark-tag">13-15</span><div class="txt-body">Interprets at least <span class="kw">three sources effectively</span>.</div></label>
        </div>
        <div class="card">
            <span class="strand-title">Strand 2: Analysis of Claim</span>
            <label class="row-opt"><input type="radio" name="p3ss2" value="1" onchange="upd()"><span class="mark-tag">1-3</span><div class="txt-body">Response is <span class="kw">mostly descriptive</span>. Analysis superficial.</div></label>
            <label class="row-opt"><input type="radio" name="p3ss2" value="2" onchange="upd()"><span class="mark-tag">4-6</span><div class="txt-body">Discussion of validity is <span class="kw">limited</span>.</div></label>
            <label class="row-opt"><input type="radio" name="p3ss2" value="3" onchange="upd()"><span class="mark-tag">7-9</span><div class="txt-body">Critical analysis <span class="kw">lacks depth</span>. conclusion partially supported.</div></label>
            <label class="row-opt"><input type="radio" name="p3ss2" value="4" onchange="upd()"><span class="mark-tag">10-12</span><div class="txt-body">Contains <span class="kw">critical analysis</span>; detailed discussion of validity.</div></label>
            <label class="row-opt"><input type="radio" name="p3ss2" value="5" onchange="upd()"><span class="mark-tag">13-15</span><div class="txt-body"><span class="kw">Well-developed critical analysis</span>; reasoning presented.</div></label>
        </div>
        <div class="card">
            <span class="strand-title">Strand 3: Evaluation of POV</span>
            <label class="row-opt"><input type="radio" name="p3ss3" value="1" onchange="upd()"><span class="mark-tag">1-3</span><div class="txt-body"><span class="kw">Little/no discussion</span> of points of view. conclusion missing.</div></label>
            <label class="row-opt"><input type="radio" name="p3ss3" value="2" onchange="upd()"><span class="mark-tag">4-6</span><div class="txt-body">Little relevant discussion; conclusion <span class="kw">inconsistent</span>.</div></label>
            <label class="row-opt"><input type="radio" name="p3ss3" value="3" onchange="upd()"><span class="mark-tag">7-9</span><div class="txt-body">Different points of view are <span class="kw">identified</span>.</div></label>
            <label class="row-opt"><input type="radio" name="p3ss3" value="4" onchange="upd()"><span class="mark-tag">10-12</span><div class="txt-body">Different points of view <span class="kw">identified</span>; argument consistent.</div></label>
            <label class="row-opt"><input type="radio" name="p3ss3" value="5" onchange="upd()"><span class="mark-tag">13-15</span><div class="txt-body">Different points of view <span class="kw">evaluated</span>; reasoned conclusion.</div></label>
        </div>
        <input type="number" class="manual-grade-field" id="man-p3q4" oninput="upd()"><textarea id="comm-p3q4" placeholder="Comment" oninput="save()"></textarea>
    </div>

    <!-- IA -->
    <div id="ia" class="view"><span class="guide-ref">Guide Page 64-65</span><h1>IA: Research Proposal</h1><div class="header-anchor"></div>
        <div class="card"><span class="strand-title">Crit A: Intro (6m)</span><label class="row-opt"><input type="radio" name="iaar" value="2" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body">Aim broad. Studies not relevant.</div></label><label class="row-opt"><input type="radio" name="iaar" value="4" onchange="upd()"><span class="mark-tag">3-4</span><div class="txt-body">Aim partially focused. 2 studies linked.</div></label><label class="row-opt"><input type="radio" name="iaar" value="6" onchange="upd()"><span class="mark-tag">5-6</span><div class="txt-body">Aim <span class="kw">focused</span>. Studies fully relevant.</div></label></div>
        <div class="card"><span class="strand-title">Crit B: Method (6m)</span><label class="row-opt"><input type="radio" name="iabr" value="2" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body">Method errors. Procedure unclear.</div></label><label class="row-opt"><input type="radio" name="iabr" value="4" onchange="upd()"><span class="mark-tag">3-4</span><div class="txt-body">Choice described. Ethics mentioned.</div></label><label class="row-opt"><input type="radio" name="iabr" value="6" onchange="upd()"><span class="mark-tag">5-6</span><div class="txt-body">Choice <span class="kw">explained</span>. Procedure detailed.</div></label></div>
        <div class="card"><span class="strand-title">Crit C: Data (6m)</span><label class="row-opt"><input type="radio" name="iacr" value="2" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body">Tool errors. Potential challenges generic.</div></label><label class="row-opt"><input type="radio" name="iacr" value="4" onchange="upd()"><span class="mark-tag">3-4</span><div class="txt-body">Tool appropriate. Decisions described.</div></label><label class="row-opt"><input type="radio" name="iacr" value="6" onchange="upd()"><span class="mark-tag">5-6</span><div class="txt-body"><span class="kw">Effective tool</span> created. Decisions explained.</div></label></div>
        <div class="card"><span class="strand-title">Crit D: Discussion (6m)</span><label class="row-opt"><input type="radio" name="iadr" value="2" onchange="upd()"><span class="mark-tag">1-2</span><div class="txt-body">Implications not addressed. Bias identified.</div></label><label class="row-opt"><input type="radio" name="iadr" value="4" onchange="upd()"><span class="mark-tag">3-4</span><div class="txt-body">Implications partially addressed. Bias described.</div></label><label class="row-opt"><input type="radio" name="iadr" value="6" onchange="upd()"><span class="mark-tag">5-6</span><div class="txt-body"><span class="kw">Implications explained</span>. Additional method discussed.</div></label></div>
        <input type="number" class="manual-grade-field" id="man-ia" oninput="upd()"><textarea id="comm-ia" placeholder="Comment" oninput="save()"></textarea>
    </div>

    <!-- EXPORT MANAGER -->
    <div id="export" class="view">
        <h1>Export Manager</h1>
        <p class="desc">Only sections with rubrics marked or comments provided will appear in the export list.</p>
        <div class="card" id="export-list"></div>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button class="btn btn-blue" onclick="doExport('simple')">Download Simple Feedback (.txt)</button>
            <button class="btn btn-green" onclick="doExport('student')">Generate AI Drafting Prompt (Student-Facing)</button>
            <button class="btn btn-purple" onclick="doExport('teacher')">Generate AI Formatted Report (Teacher-Facing)</button>
        </div>
    </div>

    <!-- HELP VIEW -->
    <div id="help" class="view">
        <h1>Help & Pedagogy</h1>
        <div class="card">
            <h3>Utility Guide</h3>
            <p><strong>Exams (Averaged Best-Fit):</strong> Calculates achievement across strands to identify the most appropriate mark range.</p>
            <p><strong>IA (Summative):</strong> Sums achievements from Criteria A-D to provide a final cumulative total out of 24.</p>
            <p><strong>AI Reports:</strong> Processes teacher shorthand into polished reports. Fixes spelling/grammar without altering judgment. Identifies "Top 3" improvement areas based on ROI (lowest achieving strands).</p>
        </div>
    </div>

    <!-- BOTTOM DOCK -->
    <div class="dock-bar">
        <div class="fit-info">
            <h3 id="fit-title">Select descriptors...</h3>
            <p id="fit-logic">Sums IA marks; averages Exam markbands.</p>
        </div>
        <div class="res-box">
            <span class="res-val" id="score-out">0</span>
            <span class="res-lbl">Total / Best-Fit</span>
        </div>
    </div>

</div>

<script>
    const KEY = 'psych2027_vFinal_FullRubric';

    document.querySelectorAll('.view:not(#export):not(#help)').forEach(v => {
        const anchor = v.querySelector('.header-anchor');
        const clone = document.getElementById('section-header').content.cloneNode(true);
        v.insertBefore(clone, anchor);
    });

    function nav(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('#sidebar a').forEach(a => a.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        const btn = document.getElementById('btn-' + id);
        if(btn) btn.classList.add('active');
        window.scrollTo(0,0);
        if(id === 'export') renderExport();
        upd();
    }

    function upd() {
        const active = document.querySelector('.view.active');
        if(!active || ['export','help'].includes(active.id)) return;
        const manField = active.querySelector('.manual-grade-field');
        const checked = active.querySelectorAll('input[type="radio"]:checked');
        const display = document.getElementById('score-out');
        const title = document.getElementById('fit-title');

        if(manField && manField.value !== "") {
            display.innerText = manField.value;
            title.innerText = "Manual Override";
            save(); return;
        }

        if (checked.length === 0) { display.innerText = "0"; title.innerText = "Select descriptors..."; return; }

        let pts = 0; checked.forEach(r => pts += parseFloat(r.value));
        let vid = active.id;

        if (vid === 'ia') {
            display.innerText = pts;
            title.innerText = `IA Summative Total: ${pts} / 24`;
        } else if (['p1c', 'p2b', 'p3q4'].includes(vid)) {
            let avg = pts / checked.length;
            const ranges = ["0", "1-3", "4-6", "7-9", "10-12", "13-15"];
            display.innerText = ranges[Math.round(avg)];
            title.innerText = ["N/A", "Rudimentary", "Basic", "Satisfactory", "Good", "Excellent"][Math.round(avg)] + " Band";
        } else {
            let avg = pts / checked.length;
            display.innerText = Math.round(avg * 2);
            title.innerText = avg > 1.5 ? "Detailed/Strong" : "Developing";
        }
        save();
    }

    function save() {
        const data = {};
        document.querySelectorAll('input[type="radio"]:checked').forEach(r => data[r.name] = r.value);
        document.querySelectorAll('textarea, .q-field, .manual-grade-field').forEach(t => {
            const id = t.id || t.className+t.closest('.view').id;
            data[id] = t.value;
        });
        localStorage.setItem(KEY, JSON.stringify(data));
    }

    function load() {
        const raw = localStorage.getItem(KEY); if(!raw) return;
        const data = JSON.parse(raw);
        for(let k in data) {
            const rad = document.querySelector(`input[name="${k}"][value="${data[k]}"]`);
            if(rad) rad.checked = true;
            const fields = document.querySelectorAll('textarea, .q-field, .manual-grade-field');
            fields.forEach(f => {
                if((f.id === k) || (f.className+f.closest('.view').id === k)) f.value = data[k];
            });
        }
        upd();
    }

    function resetRubrics() {
        if(confirm("Reset all rubrics and comments for this student? (Questions will stay)")) {
            document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
            document.querySelectorAll('textarea, .manual-grade-field').forEach(t => t.value = "");
            save(); upd();
        }
    }

    function resetAll() {
        if(confirm("Full Reset: Clear everything including questions?")) { localStorage.removeItem(KEY); location.reload(); }
    }

    function renderExport() {
        const list = document.getElementById('export-list');
        list.innerHTML = "";
        document.querySelectorAll('.view').forEach(v => {
            if(['export','help'].includes(v.id)) return;
            const hasMarking = v.querySelectorAll('input[type="radio"]:checked').length > 0;
            const hasComment = v.querySelector('textarea').value.trim() !== "";
            const isCompleted = hasMarking || hasComment;
            const row = document.createElement('div');
            row.className = `export-row ${!isCompleted ? 'disabled' : ''}`;
            row.innerHTML = `<input type="checkbox" id="chk-${v.id}" ${isCompleted ? 'checked' : ''}> <label>${v.querySelector('h1').innerText}</label>`;
            list.appendChild(row);
        });
    }

    function doExport(type) {
        let text = "IB PSYCHOLOGY 2027 ASSESSMENT DATA\n======================================\n\n";
        document.querySelectorAll('.view').forEach(v => {
            const chk = document.getElementById('chk-'+v.id);
            if(chk && chk.checked) {
                const q = v.querySelector('.q-field').value;
                const man = v.querySelector('.manual-grade-field').value;
                text += `SECTION: ${v.querySelector('h1').innerText}\n`;
                if(q) text += `PROMPT: ${q}\n`;
                v.querySelectorAll('input[type="radio"]:checked').forEach(r => {
                    text += `- ${r.closest('.card').querySelector('.strand-title').innerText}: [LEVEL_VAL:${r.value}] ${r.parentElement.innerText.trim()}\n`;
                });
                if(man) text += `ASSIGNED MARK: ${man}\n`;
                if(v.querySelector('textarea').value) text += `TEACHER COMMENT: ${v.querySelector('textarea').value}\n`;
                text += "\n---\n";
            }
        });

        if(type === 'student') {
            text = `ACT AS AN IB PSYCHOLOGY TUTOR (2027 GUIDE). Identify the "Keyword Shift" for drafting based on this data:\n\n${text}`;
        } else if(type === 'teacher') {
            text = `ACT AS A FORMAL PEDAGOGICAL FEEDBACK PROCESSOR (IB PSYCHOLOGY 2027 GUIDE). 
INSTRUCTIONS:
1. Fix grammar/typos in Teacher Comments without altering tone.
2. Group feedback by Exam Paper/IA.
3. Priority Plan: Identify Top 3 high-ROI improvement areas based on lowest achieving strands.
DATA:\n${text}`;
        }

        const blob = new Blob([text], {type: "text/plain"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `IBPsych2027_${type}.txt`;
        a.click();
    }

    window.onload = load;
</script>
</body>
</html>
